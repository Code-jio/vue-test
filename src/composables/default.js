import { ref, nextTick } from "vue";

let engine = null;
let baseScene = null;
let renderLoop = null;
let modelMarkerPlugin = null;
let skyBoxPlugin = null;
let resourceReaderPlugin = null;
let mousePickPlugin = null;
let buildingControlPlugin = null;
let css3dPlugin = null;
let floorManager = null;

const useEngine = () => {
    try {
        engineInitialize();
    } catch (error) {
        console.error(error);
    }
}

const engineInitialize = async () => {
    engine = new EngineKernel.BaseCore({
        pluginsParams: [
            {
                name: "baseScenePlugin",
                path: "/plugins/scene",
                pluginClass: EngineKernel.BaseScene,
                userData: {
                    floorConfig: {
                        enabled: true,
                        type: 'water',
                        size: 25000,
                        position: [0, 0, 0],
                        waterConfig: {
                            textureWidth: 512,
                            textureHeight: 512,
                            alpha: 1.0,
                            time: 0,
                            waterColor: 0x4a90e2,
                            distortionScale: 2.0,
                            waterNormalsUrl: "./textures/waternormals.jpg",
                            animationSpeed: 0.3,
                            waveScale: 0.5
                        },
                    },
                    debugConfig: {
                        enabled: true,
                        gridHelper: false,
                        axesHelper: true,
                    }
                } // ÂêéÁª≠Â∞ÜuserDataÊîπ‰∏∫config
            },
            {
                name: "ResourceReaderPlugin",
                path: "/plugins/ResourceReaderPlugin",
                supportedFormats: ["gltf", "glb"],
                pluginClass: EngineKernel.ResourceReaderPlugin,
                userData: {
                    url: "/",
                },
            }
        ]
    })

    baseScene = engine.getPlugin("baseScenePlugin");

    // ÂêéÁª≠renderLoop ËÄÉËôëÈõÜÊàêËá≥ÂÖ∂‰ªñÊèí‰ª∂
    engine.register({
        name: "RenderLoopPlugin",
        path: "/plugins/webgl/renderLoop",
        pluginClass: EngineKernel.RenderLoop,
        userData: {
            scene: baseScene.scene,
        },
    }).register({
        name: "ModelMarkerPlugin",
        path: "/plugins/webgl/3DModelMarker",
        pluginClass: EngineKernel.ModelMarker,
        userData: {
            scene: baseScene.scene,
        },
    }).register({
        name: "SkyBoxPlugin",
        path: "/plugins/webgl/SkyBox",
        pluginClass: EngineKernel.SkyBox,
        userData: {
            scene: baseScene.scene,
            camera: baseScene.camera,
            renderer: baseScene.renderer,
            skyBoxType: EngineKernel.SkyBoxType.HDR_ENVIRONMENT,
            hdrMapPath: './skybox/rustig_koppie_puresky_2k.hdr',
        },
    }).register({
        name: "CSS3DRenderPlugin",
        path: "/plugins/webgl/css3DRender",
        pluginClass: EngineKernel.CSS3DRenderPlugin,
        userData: {
            scene: baseScene.scene,
            renderer: baseScene.renderer,
            camera: baseScene.camera,
            container: document.getElementById("css3d-container"),
        }
    }).register({
        name: "MousePickPlugin",
        path: "/plugins/webgl/mousePickPlugin",
        pluginClass: EngineKernel.MousePickPlugin,
        userData: {
            scene: baseScene.scene,
            camera: baseScene.camera,
            renderer: baseScene.renderer,
            controller: baseScene.controlsInstance,
        }
    }).register({
        name: "BuildingControlPlugin",
        path: "/plugins/webgl/BuildingControlPlugin",
        pluginClass: EngineKernel.BuildingControlPlugin,
        userData: {
            floorControlConfig: {
                expandDistance: 30,
                animationDuration: 1500,
                focusOpacity: 1.0,
                unfocusOpacity: 0.3,
                easingFunction: 'Cubic.InOut',
                showFacade: true,
                autoHideFacade: true
            },
            events: {
                onExpandStart: () => {
                    console.log('üèóÔ∏è Ê•ºÂ±ÇÂºÄÂßãÂ±ïÂºÄ');
                },
                onExpandComplete: () => {
                    console.log('‚úÖ Ê•ºÂ±ÇÂ±ïÂºÄÂÆåÊàê');
                    updateFloorControlStatus();
                },
                onCollapseStart: () => {
                    console.log('üèóÔ∏è Ê•ºÂ±ÇÂºÄÂßãÊî∂Âõû');
                },
                onCollapseComplete: () => {
                    console.log('‚úÖ Ê•ºÂ±ÇÊî∂ÂõûÂÆåÊàê');
                    updateFloorControlStatus();
                },
                onFloorFocus: (floorNumber) => {
                    console.log(`üéØ ËÅöÁÑ¶Âà∞ ${floorNumber} Ê•º`);
                    updateFloorControlStatus();
                },
                onFloorUnfocus: () => {
                    console.log('üëÅÔ∏è ÂèñÊ∂àÊ•ºÂ±ÇËÅöÁÑ¶');
                    updateFloorControlStatus();
                }
            }
        },
    });

    // ÂêØÂä®Ê∏≤ÊüìÂæ™ÁéØ
    renderLoop = engine.getPlugin("RenderLoopPlugin");
    if (renderLoop) {
        renderLoop.initialize();
    }
    resourceReaderPlugin = engine.getPlugin("ResourceReaderPlugin");
    mousePickPlugin = engine.getPlugin("MousePickPlugin");
    buildingControlPlugin = engine.getPlugin("BuildingControlPlugin");
    css3dPlugin = engine.getPlugin("CSS3DRenderPlugin");
    modelMarkerPlugin = engine.getPlugin("ModelMarkerPlugin");

    // Ëé∑ÂèñÊ•ºÂ±ÇÁÆ°ÁêÜÂô®ÂÆû‰æã
    floorManager = baseScene.floorManager;
    
    // Êö¥Èú≤Ê∞¥Èù¢ÊéßÂà∂ÊñπÊ≥ïÂà∞ÂÖ®Â±ÄÔºàÊñπ‰æøË∞ÉËØïÔºâ
    if (typeof window !== 'undefined') {
        window.setWaterAnimationSpeed = (speed) => {
            if (floorManager) {
                floorManager.setWaterAnimationSpeed(speed);
                console.log(`Ê∞¥Èù¢Âä®ÁîªÈÄüÂ∫¶ËÆæÁΩÆ‰∏∫: ${speed}`);
            }
        };
        window.setWaterWaveIntensity = (intensity) => {
            if (floorManager) {
                floorManager.setWaterWaveIntensity(intensity);
                console.log(`Ê∞¥Èù¢Ê≥¢Êµ™Âº∫Â∫¶ËÆæÁΩÆ‰∏∫: ${intensity}`);
            }
        };
        window.setWaterDistortionScale = (scale) => {
            if (floorManager) {
                floorManager.setWaterDistortionScale(scale);
                console.log(`Ê∞¥Èù¢Êâ≠Êõ≤ÊØî‰æãËÆæÁΩÆ‰∏∫: ${scale}`);
            }
        };
        window.setWaterColor = (color) => {
            if (floorManager) {
                floorManager.setWaterColor(color);
                console.log(`Ê∞¥Èù¢È¢úËâ≤ËÆæÁΩÆ‰∏∫: 0x${color.toString(16)}`);
            }
        };
        window.getWaterParams = () => {
            return floorManager ? floorManager.getWaterParams() : null;
        };
        
        console.log('üåä ÁÆÄÂåñÊ∞¥Èù¢ÊéßÂà∂ÊñπÊ≥ïÂ∑≤Êö¥Èú≤Âà∞ÂÖ®Â±Ä:');
        console.log('- window.setWaterAnimationSpeed(speed) // 0.1-5.0 Âä®ÁîªÈÄüÂ∫¶');
        console.log('- window.setWaterWaveIntensity(intensity) // 0.0-3.0 Ê≥¢Êµ™Âº∫Â∫¶');
        console.log('- window.setWaterDistortionScale(scale) // 0.0-8.0 Êâ≠Êõ≤Á®ãÂ∫¶');
        console.log('- window.setWaterColor(0xHEXCOLOR) // Ê∞¥Èù¢È¢úËâ≤');
        console.log('- window.getWaterParams() // Ëé∑ÂèñÂΩìÂâçÂèÇÊï∞');
    }

    modelMarkerPlugin.init(engine)
}

// ÊâπÈáèÂä†ËΩΩÊ®°Âûã
const loadBatchModels = async (modelFiles) => {
    const resourceReaderPlugin = engine.getPlugin("ResourceReaderPlugin");
    if (!resourceReaderPlugin) {
        console.error("ResourceReaderPlugin not found");
        return;
    }
    const loadedModels = [];
    const loadPromises = modelFiles.map(async (modelPath, index) => {
        // ‰øÆÂ§çË∑ØÂæÑÊ†ºÂºèÔºöÊõøÊç¢ÂèçÊñúÊù†‰∏∫Ê≠£ÊñúÊù†ÔºåÂπ∂Á°Æ‰øùË∑ØÂæÑÊ†ºÂºèÊ≠£Á°Æ
        const fixedPath = modelPath.replace(/\\/g, '/');
        const fullPath = fixedPath.startsWith('/') ? fixedPath : `/${fixedPath}`;

        // Âä†ËΩΩÊ®°Âûã
        const model = await resourceReaderPlugin.loadModelAsync(
            fullPath,
            EngineKernel.TaskPriority.MEDIUM,
            {
                timeout: 30000,
                retryCount: 1,
                category: 'batch_load'
            }
        );

        // Ê∑ªÂä†Âà∞Âú∫ÊôØ
        baseScene.scene.add(model);
        // ËÆæÁΩÆÊ®°ÂûãÂêçÁß∞
        resourceReaderPlugin.setModelName(model, modelPath);

        // ËÆæÁΩÆÊ®°ÂûãÊòØÂê¶‰∏∫Âª∫Á≠ëÊ®°Âûã
        const isBuildingModel = resourceReaderPlugin.isBuildingModel(modelPath);
        if (isBuildingModel) {
            buildingControlPlugin.setBuildingModel(model);
        }


        return model;
    });

    // Á≠âÂæÖÊâÄÊúâÊ®°ÂûãÂä†ËΩΩÂÆåÊàê
    const results = await Promise.allSettled(loadPromises);

    // ÁªüËÆ°Âä†ËΩΩÁªìÊûú
    results.forEach((result, index) => {
        if (result.status === 'fulfilled' && result.value) {
            loadedModels.push(result.value);
        }
    });

    console.log(`ÊâπÈáèÂä†ËΩΩÂÆåÊàêÔºÅÊàêÂäüÂä†ËΩΩ ${loadedModels.length}/${modelFiles.length} ‰∏™Ê®°Âûã`);
    return loadedModels;
}


// Ê∑ªÂä†Ê®°ÂûãÔºö\public\MAN.gltf ‰Ωú‰∏∫3DmodelmarkerÔºåÁÑ∂ÂêéÊâßË°åmoveByPathÊñπÊ≥ïÔºå‰ΩøÁî®modelMarkerPluginÁöÑÂÜÖÁΩÆÊñπÊ≥ï
const loadModel = async (url = '/MAN.gltf', options = {}) => {
    if (!modelMarkerPlugin) {
        console.error("‚ùå ModelMarkerPlugin not found");
        return null;
    }

    try {
        // ÂêàÂπ∂ÈªòËÆ§ÈÖçÁΩÆ
        const config = {
            modelUrl: url,
            name: options.name || `Model_${Date.now()}`,
            position: options.position || [0, 0, 0],
            rotation: options.rotation || [0, 0, 0],
            scale: options.scale || [1, 1, 1],
            show: options.show !== undefined ? options.show : true,
            autoLoad: options.autoLoad !== undefined ? options.autoLoad : true,
            enableAnimations: options.enableAnimations !== undefined ? options.enableAnimations : true,
            ...options
        };
        
        // Ê∑ªÂä†Ê®°ÂûãÂà∞ModelMarker
        const modelInstance = await modelMarkerPlugin.addModel(config);
        console.log('üåê Ê®°ÂûãÊ∑ªÂä†ÁªìÊûú:', modelInstance.id, modelInstance.model);        
        
        if (!modelInstance || !modelInstance.id) {
            throw new Error('Ê®°ÂûãÊ∑ªÂä†Â§±Ë¥•ÔºåÊú™ËøîÂõûÊúâÊïàÁöÑÊ®°ÂûãÂÆû‰æã');
        }
        
        const modelId = modelInstance.id;
        modelMarkerPlugin.setModelColor(modelId, [255, 0, 0]);

        // ÂàõÂª∫Â¢ûÂº∫ÁöÑÊ®°ÂûãÊéßÂà∂Âô®
        const modelController = {
            id: modelId,
            url: url,
            config: config,

            // Ë∑ØÂæÑÁßªÂä®ÂäüËÉΩ
            moveByPath: (pathPoints, moveOptions = {}) => {
                const instance = modelMarkerPlugin.getModelById(modelId);
                if (!instance || !instance.model) {
                    console.error('‚ùå Ê®°ÂûãÊú™Âä†ËΩΩÔºåÊó†Ê≥ïÊâßË°åË∑ØÂæÑÁßªÂä®');
                    return null;
                }

                const pathConfig = {
                    pathPoints: pathPoints,
                    duration: 5000,
                    loop: false,
                    autoStart: true,
                    showPath: true,
                    pathLineColor: 0x00ff00,
                    pathLineWidth: 2,
                    easing: 'easeInOut',
                    lookAtDirection: true,
                    cycle: true,
                    // onStart: () => console.log(`üé¨ Ê®°Âûã ${modelId} ÂºÄÂßãË∑ØÂæÑÁßªÂä®`),
                    onUpdate: (progress) => {
                        // if (moveOptions.showProgress !== false) {
                            // console.log(`üìç ${modelId} ÁßªÂä®ËøõÂ∫¶: ${Math.round(progress * 100)}%`);
                        // }
                    },
                    // onComplete: () => console.log(`üèÅ Ê®°Âûã ${modelId} Ë∑ØÂæÑÁßªÂä®ÂÆåÊàê`),
                    // onStop: () => console.log(`‚èπÔ∏è Ê®°Âûã ${modelId} Ë∑ØÂæÑÁßªÂä®ÂÅúÊ≠¢`),
                    ...moveOptions
                };

                return modelMarkerPlugin.moveByPath(instance.model, pathConfig);
            },
        };

        return modelController;

    } catch (error) {
        console.error(`‚ùå Âä†ËΩΩÊ®°ÂûãÂ§±Ë¥•: ${url}`, error);
        throw error;
    }
};

// Ëé∑ÂèñÈöèÊú∫ÁÇπ‰Ωç
const getRandomPosition = (min = -30, max = 30) => {
    const random = (a, b) => Math.random() * (b - a) + a;
    return {
        x: random(min, max),
        y: 0,
        z: random(min, max)
    };
}

// Âø´ÈÄüÂàõÂª∫ÊºîÁ§∫Ë∑ØÂæÑÂä®ÁîªÁöÑËæÖÂä©ÂáΩÊï∞
const createPathDemo = async (modelUrl = '/MAN.gltf') => {
    try {
        // Âä†ËΩΩÊ®°Âûã
        const modelController = await loadModel(modelUrl, {
            name: 'PathDemoModel',
            position: [0, 5, 0],
            scale: [5, 5, 5] // Áº©Â∞è‰∏Ä‰∫õ‰æø‰∫éËßÇÂØü
        });
        
        // ÂÆö‰πâ‰∏Ä‰∏™Á§∫‰æãË∑ØÂæÑ - Ê≠£ÊñπÂΩ¢Ë∑ØÂæÑ
        const demoPath = [];
        for (let index = 0; index < 8; index++) {
            demoPath.push(getRandomPosition())            
        }
        
        // ÂêØÂä®Ë∑ØÂæÑÂä®Áîª
        const pathAnimation = modelController.moveByPath(demoPath, {
            duration: 8000,
            loop: true,
            showPath: true,
            pathLineColor: 0xff0000, // Êîπ‰∏∫Á∫¢Ëâ≤ÔºåÊõ¥ÂÆπÊòìÁúãÂà∞
            pathLineWidth: 5, // Â¢ûÂä†Á∫øÂÆΩÔºåÊµãËØïÁÆ°ÈÅìÂá†‰Ωï‰Ωì
            easing: 'linear',
        });
        
        // Â∞ÜÊéßÂà∂Âô®Êö¥Èú≤Âà∞ÂÖ®Â±Ä‰ª•‰æøË∞ÉËØï
        if (typeof window !== 'undefined') {
            window.pathDemoController = {
                model: modelController,
                animation: pathAnimation,
                stop: () => pathAnimation.stop(),
                start: () => pathAnimation.start(),
                remove: () => modelController.remove()
            };
            console.log('üåê Ë∑ØÂæÑÊºîÁ§∫ÊéßÂà∂Âô®Â∑≤Êö¥Èú≤Âà∞ÂÖ®Â±Ä: window.pathDemoController');
        }
        
        return { modelController, pathAnimation };
        
    } catch (error) {
        console.error('‚ùå ÂàõÂª∫Ë∑ØÂæÑÊºîÁ§∫Â§±Ë¥•:', error);
        throw error;
    }
};

const createFireMarker = (options = {}) => {
    // ÂêàÂπ∂ÈªòËÆ§ÈÖçÁΩÆ - ‰ΩøÁî®‰ºòÂåñÂêéÁöÑÈÖçÁΩÆ
    const config = {
        position: [0, 20, 0],
        size: 15.0,
        billboard: true,
        visible: true,
        intensity: 1.0,
        animationSpeed: 1.0,
        baseColor: 0xff4400,
        tipColor: 0xffff00,
        opacity: 1.0,
        flickerIntensity: 0.3,
        waveAmplitude: 0.2,
        depthWrite: false,
        depthTest: true, // ÂêØÁî®Ê∑±Â∫¶ÊµãËØï
        renderOrder: 0, // ËÆæÁΩÆÊ∏≤ÊüìÈ°∫Â∫è
        // Êñ∞Â¢û‰ºòÂåñÂ±ûÊÄß
        turbulenceScale: 2, // ÊπçÊµÅÂº∫Â∫¶
        windDirection: [0.1, 0.05], // ËΩªÂæÆÁöÑÈ£éÂêë
        windStrength: 0.3, // È£éÂäõÂº∫Â∫¶
        fireHeight: 1.8, // ÁÅ´ÁÑ∞È´òÂ∫¶ÊØî‰æã
        coreIntensity: 0.1, // Ê†∏ÂøÉ‰∫ÆÂ∫¶
        edgeSoftness: 0.7, // ËæπÁºòÊüîÂíåÂ∫¶
        temperatureVariation: 0.4, // Ê∏©Â∫¶ÂèòÂåñ
        sparkleIntensity: 0.5, // ÁÅ´ÊòüÊïàÊûú
        debugMode: true,
        ...options
    };

    console.log('üî• ÂàõÂª∫ FireMarkerÔºåÈÖçÁΩÆ:', config);
    
    let fire = null;
    try {
        fire = new EngineKernel.FireMarker(config);
        console.log('üî• FireMarker ÂàõÂª∫ÊàêÂäü:', fire);
    } catch (error) {
        console.error('‚ùå FireMarker ÂàõÂª∫Â§±Ë¥•:', error);
        return null;
    }
    
    // Ê∑ªÂä†Âà∞Ê∏≤ÊüìÂæ™ÁéØ‰∏≠ËøõË°åÊõ¥Êñ∞
    if (renderLoop) {
        // Ê£ÄÊü•ÁÅ´ÁÑ∞ÂØπË±°ÊòØÂê¶ÊúâupdateÊñπÊ≥ï
        if (typeof fire.update === 'function') {
            // ‰ΩøÁî®ÂîØ‰∏ÄIDÊ∑ªÂä†ÁÅ´ÁÑ∞Êõ¥Êñ∞‰ªªÂä°
            const fireTaskId = `fire-update-${Date.now()}`;
            renderLoop.addTask(fireTaskId, () => fire.update(), 0);
            
            // Â∞Ü‰ªªÂä°ID‰øùÂ≠òÂà∞ÁÅ´ÁÑ∞ÂØπË±°‰∏≠Ôºå‰ª•‰æøÂêéÁª≠ÁßªÈô§
            fire.renderTaskId = fireTaskId;
            console.log('‚úÖ ÁÅ´ÁÑ∞Êõ¥Êñ∞‰ªªÂä°Â∑≤Ê∑ªÂä†Âà∞Ê∏≤ÊüìÂæ™ÁéØÔºå‰ªªÂä°ID:', fireTaskId);
        } else {
            console.error('‚ùå FireMarker ÂØπË±°Ê≤°Êúâ update ÊñπÊ≥ï');
        }
    } else {
        console.error('‚ùå RenderLoop Êú™ÂàùÂßãÂåñÔºåÊó†Ê≥ïÊ∑ªÂä†ÁÅ´ÁÑ∞Êõ¥Êñ∞‰ªªÂä°');
    }
    
    // Êö¥Èú≤ÊéßÂà∂ÊñπÊ≥ïÂà∞ÂÖ®Â±ÄÔºåÊñπ‰æøË∞ÉËØï
    if (typeof window !== 'undefined') {
        window.fireMarker = fire;
        window.fireMarkerControls = {
            // Âü∫Á°ÄÊéßÂà∂
            setPosition: (x, y, z) => fire.setPosition([x, y, z]),
            setSize: (size) => fire.setSize(size),
            setIntensity: (intensity) => fire.setIntensity(intensity),
            setVisible: (visible) => fire.setVisible(visible),
            
            // Âä®ÁîªÊéßÂà∂
            startAnimation: () => fire.startAnimation(),
            stopAnimation: () => fire.stopAnimation(),
            
            // Êñ∞Â¢û‰ºòÂåñÊéßÂà∂ÊñπÊ≥ï
            setWind: (directionX, directionY, strength) => fire.setWind([directionX, directionY], strength),
            setCoreIntensity: (intensity) => fire.setCoreIntensity(intensity),
            setTurbulence: (scale) => fire.setTurbulence(scale),
            setSparkle: (intensity) => fire.setSparkle(intensity),
            
            // Âø´ÈÄüÈ¢ÑËÆæ
            presets: {
                // Ê∏©ÂíåÁÅ´ÁÑ∞
                gentle: () => {
                    fire.setIntensity(0.7);
                    fire.setWind([0.05, 0.02], 0.1);
                    fire.setTurbulence(0.8);
                    fire.setSparkle(0.1);
                    console.log('üî• Â∫îÁî®Ê∏©ÂíåÁÅ´ÁÑ∞È¢ÑËÆæ');
                },
                // ÁãÇÈáéÁÅ´ÁÑ∞
                wild: () => {
                    fire.setIntensity(1.0);
                    fire.setWind([0.2, 0.1], 0.5);
                    fire.setTurbulence(1.5);
                    fire.setSparkle(0.5);
                    console.log('üî• Â∫îÁî®ÁãÇÈáéÁÅ´ÁÑ∞È¢ÑËÆæ');
                },
                // Á•ûÁßòÁÅ´ÁÑ∞
                mystical: () => {
                    fire.setIntensity(0.9);
                    fire.setWind([0.0, 0.0], 0.0);
                    fire.setTurbulence(2.0);
                    fire.setSparkle(0.3);
                    fire.setCoreIntensity(2.0);
                    console.log('üî• Â∫îÁî®Á•ûÁßòÁÅ´ÁÑ∞È¢ÑËÆæ');
                },
                // È£é‰∏≠ÁÅ´ÁÑ∞
                windy: () => {
                    fire.setIntensity(0.8);
                    fire.setWind([0.3, 0.0], 0.7);
                    fire.setTurbulence(1.2);
                    fire.setSparkle(0.4);
                    console.log('üî• Â∫îÁî®È£é‰∏≠ÁÅ´ÁÑ∞È¢ÑËÆæ');
                }
            },
            
            // Â∑•ÂÖ∑ÊñπÊ≥ï
            getConfig: () => fire.getConfig(),
            getMesh: () => fire.getMesh(),
            
            // Ê∏ÖÁêÜÊñπÊ≥ï
            dispose: () => {
                if (renderLoop && fire.renderTaskId) {
                    renderLoop.removeTask(fire.renderTaskId);
                    console.log('üî• ÁÅ´ÁÑ∞Ê∏≤Êüì‰ªªÂä°Â∑≤ÁßªÈô§');
                }
                if (fire.dispose) {
                    fire.dispose();
                    console.log('üî• ÁÅ´ÁÑ∞ÂØπË±°Â∑≤Ê∏ÖÁêÜ');
                }
            },
            
            // Ë∞ÉËØïÂíåÊµãËØïÊñπÊ≥ï
            testVisibility: () => {
                console.log('üî• FireMarker ÊµãËØïÂèØËßÅÊÄß:');
                console.log('- ‰ΩçÁΩÆ:', fire.getPosition());
                console.log('- ÂèØËßÅÊÄß:', fire.getVisible());
                console.log('- ÈÖçÁΩÆ:', fire.getConfig());
                console.log('- ÁΩëÊ†º:', fire.getMesh());
                console.log('- Ê∏≤Êüì‰ªªÂä°ID:', fire.renderTaskId);
                
                fire.setPosition([0, 15, 0]);
                fire.setVisible(true);
                fire.setIntensity(1.0);
                console.log('üî• Â∑≤Âº∫Âà∂ËÆæÁΩÆ‰ΩçÁΩÆ‰∏∫ [0, 15, 0]ÔºåÂèØËßÅÊÄß‰∏∫ trueÔºåÂº∫Â∫¶‰∏∫ 1.0');
            },
            
            // Âä®ÊÄÅÊïàÊûúÊºîÁ§∫
            demo: {
                // È£éÂêëÂèòÂåñÊºîÁ§∫
                windDemo: () => {
                    let angle = 0;
                    const interval = setInterval(() => {
                        const x = Math.cos(angle) * 0.3;
                        const y = Math.sin(angle) * 0.3;
                        fire.setWind([x, y], 0.4);
                        angle += 0.1;
                        if (angle > Math.PI * 4) { // 2ÂúàÂêéÂÅúÊ≠¢
                            clearInterval(interval);
                            fire.setWind([0.1, 0.05], 0.3); // ÊÅ¢Â§çÈªòËÆ§
                            console.log('üî• È£éÂêëÊºîÁ§∫ÂÆåÊàê');
                        }
                    }, 100);
                    console.log('üî• ÂºÄÂßãÈ£éÂêëÂèòÂåñÊºîÁ§∫');
                },
                
                // Âº∫Â∫¶ËÑâÂÜ≤ÊºîÁ§∫
                pulseDemo: () => {
                    let time = 0;
                    const interval = setInterval(() => {
                        const intensity = 0.5 + 0.5 * Math.sin(time * 0.1);
                        fire.setIntensity(intensity);
                        time++;
                        if (time > 100) { // 10ÁßíÂêéÂÅúÊ≠¢
                            clearInterval(interval);
                            fire.setIntensity(1.0); // ÊÅ¢Â§çÈªòËÆ§
                            console.log('üî• Âº∫Â∫¶ËÑâÂÜ≤ÊºîÁ§∫ÂÆåÊàê');
                        }
                    }, 100);
                    console.log('üî• ÂºÄÂßãÂº∫Â∫¶ËÑâÂÜ≤ÊºîÁ§∫');
                }
            }
        };
        console.log('üî• ‰ºòÂåñÁâà FireMarker ÊéßÂà∂ÊñπÊ≥ïÂ∑≤Êö¥Èú≤Âà∞ÂÖ®Â±Ä:');
        console.log('üìç Âü∫Á°ÄÊéßÂà∂:');
        console.log('- window.fireMarkerControls.setPosition(x, y, z)');
        console.log('- window.fireMarkerControls.setSize(size)');
        console.log('- window.fireMarkerControls.setIntensity(0-1)');
        console.log('- window.fireMarkerControls.setVisible(true/false)');
        console.log('');
        console.log('üå™Ô∏è È´òÁ∫ßÊïàÊûú:');
        console.log('- window.fireMarkerControls.setWind(x, y, strength) // ËÆæÁΩÆÈ£éÂêëÂíåÂº∫Â∫¶');
        console.log('- window.fireMarkerControls.setCoreIntensity(0-3) // Ê†∏ÂøÉ‰∫ÆÂ∫¶');
        console.log('- window.fireMarkerControls.setTurbulence(0-3) // ÊπçÊµÅÂº∫Â∫¶');
        console.log('- window.fireMarkerControls.setSparkle(0-1) // ÁÅ´ÊòüÊïàÊûú');
        console.log('');
        console.log('üé® Âø´ÈÄüÈ¢ÑËÆæ:');
        console.log('- window.fireMarkerControls.presets.gentle() // Ê∏©ÂíåÁÅ´ÁÑ∞');
        console.log('- window.fireMarkerControls.presets.wild() // ÁãÇÈáéÁÅ´ÁÑ∞');
        console.log('- window.fireMarkerControls.presets.mystical() // Á•ûÁßòÁÅ´ÁÑ∞');
        console.log('- window.fireMarkerControls.presets.windy() // È£é‰∏≠ÁÅ´ÁÑ∞');
        console.log('');
        console.log('üé≠ Âä®ÊÄÅÊºîÁ§∫:');
        console.log('- window.fireMarkerControls.demo.windDemo() // È£éÂêëÂèòÂåñÊºîÁ§∫');
        console.log('- window.fireMarkerControls.demo.pulseDemo() // Âº∫Â∫¶ËÑâÂÜ≤ÊºîÁ§∫');
        console.log('');
        console.log('üîß Â∑•ÂÖ∑ÊñπÊ≥ï:');
        console.log('- window.fireMarkerControls.dispose() // Ê∏ÖÁêÜÁÅ´ÁÑ∞');
        console.log('- window.fireMarkerControls.testVisibility() // Ë∞ÉËØïÂèØËßÅÊÄß');
    }
    
    return fire;
}



export {
    useEngine,
    engineInitialize,
    loadBatchModels,
    loadModel,
    createPathDemo,
    createFireMarker,


    baseScene,
    engine,
    renderLoop,
    resourceReaderPlugin,
    mousePickPlugin,
    buildingControlPlugin,
    modelMarkerPlugin,
    css3dPlugin,
    floorManager,
}